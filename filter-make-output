#!/bin/bash

version_str="1.0.0"

usage_str="\
USAGE: $0 [output_file]
  Filter CMake-generated Make verbose output
"
description_str="\
DESCRIPTION:
  In a Make project generated by CMake, call Make with the verbose option and
  pipe the output to this script to have the non-verbose output printed and the
  verbose output is written to a file. If no output file name argument is
  passed, the name output.log is used.
"

options_and_returns_str="\
OPTIONS:
  -h    print help and exit
  -v    print version and exit

RETURNS:
  awk return code
"

usage() {
  printf "%s\n%s\n%s" \
    "$usage_str" \
    "$description_str" \
    "$options_and_returns_str"
}

version() {
  printf "$0 version %s\n" "$version_str"
}

while getopts "hv" arg; do
  case "${arg}" in
    h)
      usage
      exit 0
      ;;
    v)
      version
      exit 0
      ;;
  esac
done

if [ $# -eq 0 ] ; then
  output_file="output.log"
else
  output_file=$1
fi

awk_script="/\[.*%\]/ { print \$0 } { print \$0 > \"$output_file\" }"
awk "$awk_script"
